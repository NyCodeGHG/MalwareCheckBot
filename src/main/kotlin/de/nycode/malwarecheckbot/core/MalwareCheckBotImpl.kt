package de.nycode.malwarecheckbot.core

import de.nycode.malwarecheckbot.config.Config
import de.nycode.malwarecheckbot.listener.registerChatListener
import de.nycode.malwarecheckbot.listener.registerJoinListener
import de.nycode.malwarecheckbot.storage.GuildInformation
import de.nycode.malwarecheckbot.utils.createMongoClient
import dev.kord.core.Kord
import kotlinx.coroutines.Dispatchers
import kotlinx.coroutines.SupervisorJob

internal class MalwareCheckBotImpl : MalwareCheckBot {

    override val coroutineContext = Dispatchers.IO + SupervisorJob()

    override lateinit var kord: Kord

    override lateinit var repositories: Repositories

    suspend fun start() {
        kord = Kord(Config.DISCORD_TOKEN)

        repositories = initializeDatabase()

        registerJoinListener()
        registerChatListener()

        kord.login()
    }

    private fun initializeDatabase(): Repositories {
        val client = createMongoClient(Config.MONGO_CONNECTION_STRING)
        val database = client.getDatabase(Config.MONGO_DATABASE)

        val guildCollection = database.getCollection<GuildInformation>()

        return Repositories(guildCollection)
    }

}
