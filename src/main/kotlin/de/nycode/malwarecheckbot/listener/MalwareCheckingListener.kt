package de.nycode.malwarecheckbot.listener

import de.nycode.malwarecheckbot.core.MalwareCheckBot
import de.nycode.malwarecheckbot.filtering.MalwareDetector
import de.nycode.malwarecheckbot.filtering.caching.RedisMalwareCache
import dev.kord.core.event.message.MessageCreateEvent
import kotlinx.coroutines.flow.filter
import kotlinx.coroutines.flow.filterIsInstance
import kotlinx.coroutines.flow.launchIn
import kotlinx.coroutines.flow.onEach

fun MalwareCheckBot.registerChatListener() = kord.events
    .filterIsInstance<MessageCreateEvent>()
    .filter { it.member?.isBot != true }
    .onEach { event ->
        val content = event.message.content
        val urls = malwareDetector.detectUrls(content)
        if (urls.isEmpty()) {
            return@onEach
        }

        val response = malwareDetector.checkForMalware(urls)

        event.message.channel.createMessage(response.toString())

    }
    .launchIn(this)
